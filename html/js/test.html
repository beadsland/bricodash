<html>
<head>
</head>
<body>

<img src="">


<script type="text/javascript">

  const sleep = (milliseconds) => {
    return new Promise(resolve => setTimeout(resolve, milliseconds))
  }

  var snap = "../util/camera.php?view=door&action=snapshot"
  var myImage = document.querySelector('img')

  async function update_frame(myImage, snap, hook, oldObjectURL) {
    var urlParams = new URLSearchParams(window.location.search);
    whoami = urlParams.has("whoami");
    if (!whoami) { whoami = "unknown client"}
    device = `Door camera feed (${whoami})`;

    var response = await fetch(snap);

    if (!response.ok) {
      myImage.src = "";
      var msg = device +  " has gone offline :'("
      await fetch(hook, { method: 'POST', body: JSON.stringify( { text: msg } ) });

      while (!response.ok) { response = await fetch(snap); await sleep(1000); }

      msg = device + " is online again :)"
      await fetch(hook, { method: 'POST', body: JSON.stringify( { text: msg } ) });
    }

    var blob = await response.blob();
    var newObjectURL = URL.createObjectURL(blob);
    myImage.src = newObjectURL;
    URL.revokeObjectURL(oldObjectURL);

    return newObjectURL;
  };

  async function loop(myImage, snap) {
    hook_url = "../.keys/netops_hook"
    response = await fetch(hook_url)
    hook = await response.text()

    var oldObjectURL;
    var newObjectURL;
    while(true) {
      newObjectURL = await update_frame(myImage, snap, hook, oldObjectURL);
      oldObjectURL = newObjectURL;
    }
  };

  loop(myImage, snap);


</script>


</body>
</html>
