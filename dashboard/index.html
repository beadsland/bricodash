<!DOCTYPE html>
<html>
<head>
<title>Hack Manhattan Dashboard (Work in Progress)</title>
<meta charset="utf-8">
<style>
section {
  position: relative;
  z-index: 5;
}
body {
  margin: 0;
  background-color: #fff;
  color: #000;
  font-family: monospace;
  line-height: 1.5;
  font-size: 120%;
  position: relative;
  overflow: hidden;
}
body::before {
  content: ' ';
  display: block;
  left: 0;
  top: 0;
  width: 75%;
  height: 100%;
  z-index: 1;
  position: absolute;
  opacity: 0.3;
  background-image: url('hmlogo-notonair-intense.svg');
  background-repeat: no-repeat;
  background-size: auto 150%;
  background-position: center 35%;
  transition: opacity 1s cubic-bezier(0.23, 1, 0.32, 1);
}
body.surveilled::before {
  background-image: url('hmlogo-onair-intense.svg');
  opacity: 1;
  z-index: 3;
}
section {
  position: relative;
  z-index: 2;
  width: 49.5%;
  display: inline-block;
  height: 366px;
  box-sizing: border-box;
  padding: 0.5ex;
  vertical-align: top;
}
.chromecast section {
  width: 49.6%;
}
section:nth-child(even) {
  background: #000;
  color: #fff;
}
.full {
  padding: 0;
}
#corner {
  padding: 0.5ex;
  position: fixed;
  height: 5em;
  bottom: 0;
  left: 0;
}
h1, h2 {
  margin-top: 0;
  margin-bottom: 0;
}
h1 {
  background-image: url(hmtext.svg);
  background-repeat: no-repeat;
  background-size: 50%;
  padding-top: 2em;
  height: 0;
  overflow: hidden;
}
object {
  vertical-align: middle;
  margin-top: -0.2em;
  margin-right: -0.3em;
}
#slack {
  background: #4d394b;
  background-image: url(Slack_Icon.png);
  background-repeat: no-repeat;
  background-position: 115.5% -8em;
}
h2 .chromecast {
  display: none;
}
.chromecast h2 .chromecast {
  display: inline;
}
#slack #chat {
  width: 100%;
  height: calc(100% - 2em);
  border: 0;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column-reverse;
  overflow: hidden;
}

#chat p {
  margin: 0 0 0.3em 0;
  padding: 0;
}

#chat p.highlight {
  color: #000;
  background: darkorange;
  font-weight: bold;
}
#chat img {
  height: 1.5em;
  vertical-align: bottom;
}
#meetup {
  background: url(Meetup_Logo.png);
  background-size: 33%;
  background-repeat: no-repeat;
  background-position: 100% -5em;
}
h2 img {
  vertical-align: text-bottom;
}
#patreon span {
  font-weight: bold;
  font-size: 1.5em;
}
</style>
</head>
<body>
<section id="meetup">
<h1>Hack Manhattan Dashboard</h1>
<h2>Meetup Calendar</h2>
<div><a href="https://api.meetup.com/hackmanhattan/events?sign=true&amp;photo-host=public&amp;page=5">Should go here at some point</a></div>
</section>
<section id="slack">
<h2>#hackerspace on Slack</h2>
<div id="chat"></div>
</section>
<section id="patreon">
<h2><img src="Patreon_Logo.png" /><img src="patreonqr.png"/><br />patreon.com/hackmanhattan</h2>
<div><span id="patreon-money">$8</span> per month, coming from <span id="patrons">2</span> patrons</div>
<!--
<h2>Wiki Activity</h2>
<div id="wiki"><a href="https://wiki.hackmanhattan.com/api.php?hidebots=1&amp;days=30&amp;limit=5&amp;action=feedrecentchanges&amp;feedformat=atom">Hack Manhattan Recent Wiki Edits</a></div>

<h2>Nearby subway times</h2>
<a href="http://datamine.mta.info/mta_esi.php?key=a83227f540c4d8b004e1170151fc8c96&amp;feed_id=16">NRQW GTFS feed</a><br>
<a href="http://datamine.mta.info/mta_esi.php?key=a83227f540c4d8b004e1170151fc8c96&amp;feed_id=21">BDFM GTFS feed<br>
<a href="http://datamine.mta.info/mta_esi.php?key=a83227f540c4d8b004e1170151fc8c96&amp;feed_id=1">123456S GTFS feed</a><br>
<a href="http://datamine.mta.info/mta_esi.php?key=a83227f540c4d8b004e1170151fc8c96&amp;feed_id=2">L GTFS feed</a>-->
</section>
<section class="full">
<img src="http://192.168.42.157:8080/?action=stream" alt="Stream from the door" style="width: 100%" />
</section>
<div id="corner">
<h2><span class="chromecast"><object type="image/svg+xml" data="chromecast.svg">(on Chromecast)</object> Hackerspace</span>&nbsp;</h2>
<div><span id="datetime"></span></div>
<div><span id="weather"><span id="weatherf"></span>°F / <span id="weatherc"></span>°C <span id="weathert"></span></span></div>
</div>
<script src="app.js" type="text/javascript"></script>
<script src="emoji.js" type="text/javascript"></script>
<script type="text/javascript">
var emoji = new EmojiConvertor();

emoji.img_sets["google"].path = "img-google-64/";
emoji.img_set = "google";
emoji.replace_mode = "img";
emoji.supports_css = false;
emoji.init_env();

function checkTime(i) {
    if (i < 10) i = "0" + i;
    return i;
}

function msgHandler(msg) {
    var el = document.createElement("p"),
        chat = document.getElementById("chat"),
        d = new Date(0);

    d.setUTCSeconds(msg["ts"]);
    var ts = d.getHours() + ":" + checkTime(d.getMinutes());
        b = msg["body"];

    b = b.replace(/<\!(\w+)>/, "@$1");
    b = b.replace("<", "&lt;");
    b = emoji.replace_colons(b);
    for (var i = 0; i < Object.keys(msg["emoji"]).length; i++) {
        var hmemoji = Object.keys(msg["emoji"])[i];
        b = b.replace(hmemoji, "<img src='" +  msg["emoji"][hmemoji] + "'/>");
    }

    el.innerHTML = "[" + ts + "] " + msg["from"] + ": " + b;
    if (b.indexOf("@here") > -1 || b.indexOf("@channel") > -1 || b.indexOf("#hackerspace") > -1) {
        el.classList.add("highlight");
    }
    chat.insertBefore(el, chat.firstChild);

    if (chat.childElementCount > 30) {
        chat.removeChild(chat.lastChild);
    }
}

var bottest = "C4TTY27RS";
var hackerspace = "C4XS939EY";
require("js/app").App.connect(hackerspace, msgHandler, function (catchup) {
    catchup.forEach(msgHandler);
});


var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

function putTime() {
    var today = new Date();
    var h = today.getHours();
    var mi = today.getMinutes();
    var da = days[today.getDay()];
    var mo = months[today.getMonth()];
    var dt = today.getDate();
    // add a zero in front of numbers<10
    mi = checkTime(mi);
    document.getElementById('datetime').innerHTML = da + ' ' + mo  + ' ' + dt + ', ' + h + ":" + mi;
    t = setTimeout(function () {
        putTime()
    }, 2000);
}
putTime();

var getJSON = function(url, callback, rtype='json') {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = rtype;
    xhr.onload = function() {
        var status = xhr.status;
        if (status === 200 && rtype == 'text') {
            lines = xhr.response.split('\n');
            if (lines.length > 1) {
                for (var i = 0; i < lines.length; i++) {
                    if (lines[i].indexOf("{") > -1) {
                        lines[i] = JSON.parse(lines[i]);
                        if (Object.keys(lines[i]).indexOf("referer")) {
                            lines[i].kind = lines[i].action.split("/")[2].split(" ")[0].split(".")[0];
                            lines[i].time = Date.parse(lines[i].time.replace(":", " "));
                            lines[i].start = false;
                            if (lines[i].kind == "stream") lines[i].start = lines[i].action.indexOf(".html") > -1;
                        }
                    } else {
                        lines.pop(i)
                    }
                }
                callback(null, lines.reverse());
            } else {
                callback(null, []);
            }
        } else if (status === 200) {
            callback(null, xhr.response);
        } else {
            callback(status, xhr.response);
        }
    }
    xhr.send();
};

function checkPatreon() {
    getJSON('https://space.bo.x0.rs/dashboard/patreon.json', function(e,d) {
        var sum = "" + d.included[0].attributes.pledge_sum;
        document.getElementById("patreon-money").innerHTML = "$" + sum.slice(0, -2);
        document.getElementById("patrons").innerHTML = d.included[0].attributes.patron_count;
    });
    setTimeout(checkPatreon, 3600000);
}

function checkSurveillance() {
    // doesn't support concurrent streams right now, but you know ¯\_(ツ)_/¯
    getJSON('https://space.bo.x0.rs/sousveillance/agent.log?' + Math.random(), function(e,d){
        if (e != null) {
            console.log(e);
            console.log(d);
        } else {
            if (d.length > 0) {
                if (d[0].kind == "snapshot" && (new Date().getTime() / 1000) - (d[0].time / 1000) < 5) {
                    document.body.classList.add("surveilled");
                    setTimeout(function() {
                        document.body.classList.remove("surveilled");
                    }, 7500);
                } else if (d[0].kind == "stream" && d[0].start) {
                    document.body.classList.add("surveilled");
                } else if (d[0].kind == "stream" && ! d[0].start) {
                    document.body.classList.remove("surveilled");
                }
            }
        }
    }, 'text');
    setTimeout(checkSurveillance, 5000);
}

function checkWeather() {
    getJSON('https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20query.multi%20where%20queries%3D%22select%20item.condition%20from%20weather.forecast%20where%20woeid%20%3D%202459115%20and%20u%3D%27c%27%3Bselect%20item.condition%20from%20weather.forecast%20where%20woeid%20%3D%202459115%20and%20u%3D%27f%27%22&format=json&diagnostics=false&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys', function(e,d){
        if (e != null) {
            console.log(e);
            console.log(d);
        } else {
            document.getElementById('weatherc').innerHTML = d.query.results.results[0].channel.item.condition.temp;
            document.getElementById('weatherf').innerHTML = d.query.results.results[1].channel.item.condition.temp;
            document.getElementById('weathert').innerHTML = '(' + d.query.results.results[1].channel.item.condition.text + ')';
        }
    });
    setTimeout(checkWeather, 600000);
}
checkWeather();
checkSurveillance();
checkPatreon();
if (navigator.userAgent.match(/CrKey/g) != null) {
    document.body.classList.add("chromecast");
}
</script>
</body>
</html>
